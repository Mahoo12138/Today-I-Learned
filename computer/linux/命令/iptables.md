## 什么是 iptables？

- **定义**：`iptables` 是 Linux 系统内置的防火墙工具，用于配置内核级网络包过滤规则（基于 Netfilter 框架）。它管理网络流量的流向、过滤、地址转换（NAT）等。
- **核心功能**：
	- 过滤数据包（允许/拒绝流量）
	- 实现网络地址转换（NAT，如共享上网、端口转发）
	- 修改数据包内容（如 TTL、标记）
	- 流量统计与限速

## 核心概念

### 表（Tables）

不同功能的规则集合，按用途分类：

- **filter 表**：默认表，用于流量过滤（如允许/拒绝连接）
- **nat 表**：网络地址转换（如端口转发、共享 IP）
- **mangle 表**：修改数据包头（如 TTL、QoS 标记）
- **raw 表**：绕过连接跟踪机制（用于特殊优化）

### 链（Chains）

数据包处理的“关卡”，每个表包含多个链：

- **INPUT**：处理**进入本机**的数据包（如 SSH 请求）
- **OUTPUT**：处理**从本机发出**的数据包
- **FORWARD**：处理**经过本机转发**的数据包（如路由器）
- **PREROUTING**：在路由决策前修改数据包（NAT 端口转发）
- **POSTROUTING**：在路由决策后修改数据包（NAT 共享 IP）

### 规则（Rules）

- **匹配条件**：如源 IP、目标端口、协议类型（TCP/UDP/ICMP）
- **动作（Target）**：符合条件时触发的操作：
  - `ACCEPT`：允许通过，将不再比对其它规则，直接跳往下一个规则链
  - `DROP`：静默丢弃，将不再比对其它规则，直接中断过滤程序
  - `REJECT`：拒绝并并传送数据包通知对方，进行完此处理动作后，将不再比对其它规则，直接 中断过滤程序
  - `REDIRECT`： 将包重新导向到另一个端口（PNAT），进行完此处理动作后，将会继续比对其它规则
  - `SNAT`/`DNAT`：源/目标地址转换，改写封包来源/目的地 IP 为某特定 IP 或 IP 范围，可以指定 port 对应的范围，进行完此处理动作后，将直接跳往下一个规则
  - `MIRROR`：镜像数据包，也就是将来源 IP 与目的地 IP 对调后，将数据包送回，进行完此处理动作后，将会中断过滤程序
  - `QUEUE`：中断过滤程序，将数据包放入队列，交给其它程序处理
  - `MARK`：将数据包标上某个代号，以便提供作为后续过滤的条件判断依据，进行完此处理动作后，将会继续比对其它规则
  - **LOG** 将封包相关讯息记录在 `/var/log` 中，详细位置请查阅 `/etc/syslog.conf` 配置文件，进行完此处理动作后，将会继续比对其规则

## 数据包处理流程

数据包经过的链和表的顺序：

1. PREROUTING (raw → mangle → nat)
2. 路由决策（判断是发给本机还是转发）
3. 如果目标为本机 → INPUT (mangle → filter)
  1. 本机进程处理
  2. OUTPUT (raw → mangle → nat → filter)
  3. POSTROUTING (mangle → nat)
4. 如果转发 → FORWARD (mangle → filter)

![[iptables_scheme.png]]

![[iptables_flowchart.png]]
## 命令格式

`iptables` 的命令行格式大致遵循以下模式：

```bash
iptables [表] 命令选项 [链 [链序号]] [规则/参数] [扩展选项]
```

`-t` 参数用来指定规则表，当未指定规则表时，则默认为 `filter`。

### 核心命令分类

#### 规则管理

| 命令        | 缩写 | 功能                               | 示例                                              |
| :---------- | :--- | :--------------------------------- | :------------------------------------------------ |
| `--append`  | `-A` | **追加规则到链末尾**               | `iptables -A INPUT -s 1.1.1.1 -j DROP`            |
| `--insert`  | `-I` | **插入规则到指定位置**（默认链首） | `iptables -I INPUT 2 -p tcp --dport 80 -j ACCEPT` |
| `--delete`  | `-D` | **删除匹配的规则**或**按编号删除** | `iptables -D INPUT 3`（删除第3条规则）            |
| `--replace` | `-R` | **替换指定位置的规则**             | `iptables -R OUTPUT 1 -d 8.8.8.8 -j REJECT`       |
| `--check`   | `-C` | **检查规则是否存在**               | `iptables -C INPUT -s 192.168.1.0/24 -j ACCEPT`   |

#### 链管理

| 命令             | 缩写 | 功能                             | 示例                              |
| :--------------- | :--- | :------------------------------- | :-------------------------------- |
| `--new-chain`    | `-N` | **创建自定义链**                 | `iptables -N CUSTOM_CHAIN`        |
| `--delete-chain` | `-X` | **删除自定义链**（需先清空规则） | `iptables -X CUSTOM_CHAIN`        |
| `--rename-chain` | `-E` | **重命名链**                     | `iptables -E OLD_CHAIN NEW_CHAIN` |

#### 查看与维护

| 命令           | 缩写 | 功能                                   | 示例                                  |
| :------------- | :--- | :------------------------------------- | :------------------------------------ |
| `--list`       | `-L` | **列出链的规则**（支持 `-v` 详细信息） | `iptables -L INPUT -v --line-numbers` |
| `--list-rules` | `-S` | **以规则格式输出**（适合保存）         | `iptables -S > rules.txt`             |
| `--flush`      | `-F` | **清空链或所有链的规则**               | `iptables -F INPUT`（清空 INPUT 链）  |
| `--zero`       | `-Z` | **重置计数器**（流量统计归零）         | `iptables -Z INPUT`                   |

#### 默认策略

| 命令       | 缩写 | 功能                                   | 示例                     |
| :--------- | :--- | :------------------------------------- | :----------------------- |
| `--policy` | `-P` | **设置链的默认动作**（如 DROP/ACCEPT） | `iptables -P INPUT DROP` |

### 常用选项解析

#### **基本匹配条件**

| 选项              | 缩写 | 说明                                | 示例                                   |
| :---------------- | :--- | :---------------------------------- | :------------------------------------- |
| `--protocol`      | `-p` | 匹配协议（如 `tcp`, `udp`, `icmp`） | `-p tcp`                               |
| `--source`        | `-s` | 源 IP 地址（支持 `!` 取反）         | `-s 192.168.1.0/24` 或 `! -s 10.0.0.1` |
| `--destination`   | `-d` | 目标 IP 地址                        | `-d 8.8.8.8`                           |
| `--in-interface`  | `-i` | 输入网卡（如 `eth0`）               | `-i eth0`                              |
| `--out-interface` | `-o` | 输出网卡                            | `-o eth1`                              |

#### **扩展匹配与动作**

| 选项      | 缩写 | 说明                                        | 示例                                    |
| :-------- | :--- | :------------------------------------------ | :-------------------------------------- |
| `--jump`  | `-j` | **跳转到目标动作或链**（核心功能）          | `-j ACCEPT`, `-j DNAT --to 192.168.1.2` |
| `--match` | `-m` | **使用扩展模块**（如 `conntrack`, `limit`） | `-m conntrack --ctstate ESTABLISHED`    |
| `--goto`  | `-g` | **跳转到链且不返回**                        | `-g CUSTOM_CHAIN`                       |

#### 输出与调试

| 选项             | 缩写 | 说明                            | 示例                               |
| :--------------- | :--- | :------------------------------ | :--------------------------------- |
| `--numeric`      | `-n` | 显示 IP 和端口号（不解析域名）  | `iptables -L -n`                   |
| `--verbose`      | `-v` | 显示详细信息（如流量统计）      | `iptables -L -v`                   |
| `--line-numbers` |      | 显示规则的行号（便于删除/替换） | `iptables -L INPUT --line-numbers` |

### 高级选项

| 选项             | 说明                                  | 场景示例                              |
| :--------------- | :------------------------------------ | :------------------------------------ |
| `--table` (`-t`) | 指定操作的表（默认 `filter`）         | `-t nat`（操作 NAT 表）               |
| `--modprobe`     | 指定加载内核模块的命令                | `--modprobe=modprobe`（自动加载模块） |
| `--wait` (`-w`)  | 等待锁释放的最大时间（防并发冲突）    | `-w 5`（等待 5 秒）                   |
| `--set-counters` | 设置规则的初始计数器（PKTS 和 BYTES） |                                       |

## 常用命令说明

```bash
# 新增规则到 INPUT 规则链中，允许所有目的端口为 80 的 TCP 数据包的流入连接。
$ iptables -A INPUT -p tcp --dport 80 -j ACCEPT

# 定义链默认的过滤策略。数据包没有找到符合的策略，则根据此预设方式处理。
$ iptables -P INPUT DROP
```

## 注意事项

1. **规则顺序**：规则按顺序匹配，**第一条匹配后停止**，需注意优先级。
2. **默认策略**：设置 `-P DROP` 前确保允许必要流量（如 SSH）。
3. **保存规则**：重启后规则会丢失，需使用 `iptables-save` 保存配置。
4. **表与链的关联**：不同表（如 `nat`, `filter`）支持的链不同（例如 `nat` 表不支持 `FORWARD` 链）。

