## CSS 树是怎么和 DOM 树怎么结合的

### 1. **解析阶段：生成 DOM 和 CSSOM**

- **DOM 树**：浏览器解析 HTML，生成 DOM（Document Object Model）树，表示页面的结构和内容。
- **CSSOM 树**：浏览器解析 CSS（内联、外部、嵌入样式），生成 CSSOM（CSS Object Model）树，表示所有 CSS 规则及其层级关系。

### 2. **样式计算（Style Calculation）**

将 CSSOM 的规则应用到 DOM 节点上，为每个节点计算最终的样式。这一过程分为几个关键步骤：
#### a. **选择器匹配**

- 浏览器遍历 DOM 树中的每个节点，从 CSSOM 中找到 **匹配的 CSS 规则**。
- **匹配规则**：通过选择器（如 `div.class`、`#id`）将 CSS 规则与 DOM 节点关联。
- **优化机制**：浏览器通常从右向左解析选择器（例如，`.box a` 会先匹配 `<a>`，再检查父元素是否有 `.box`），以提高效率。

#### b. **层叠与优先级**

- 根据 **CSS 优先级规则**（内联样式 > ID > 类/伪类 > 元素选择器）和 **代码顺序**，确定多个规则冲突时的最终样式。
- 继承属性（如 `font-size`）会从父节点传递到子节点。

#### c. **生成 Computed Style**

- 每个 DOM 节点最终会生成一个 **计算样式（Computed Style）**，包含所有生效的 CSS 属性值（如 `width: 100px`），单位会被转换为标准形式（如 `px`）。

### 3. **构建渲染树（Render Tree）**

- 渲染树是 DOM 树和 CSSOM 的结合体，但**仅包含可见的节点**（如 `display: none` 的元素不会包含在内），是浏览器实际用于渲染页面的结构。
- 每个渲染树节点（Render Object）对应一个 DOM 节点及其计算样式，并保存布局和绘制所需的信息（如大小、颜色、位置等）。

**关键区别**：

- DOM 树包含所有节点（包括不可见的）。
- 渲染树仅包含需要实际绘制的节点。

### 4. **布局（Layout/Reflow）

在**布局**阶段，浏览器根据 **Render 树** 中的元素以及它们的样式来计算每个元素的实际位置和大小。这个过程也称为 **重排（Reflow）**。

- 通过计算 **盒模型（box model）** 和 **样式（例如 `margin`, `padding`, `border`, `width`, `height` 等）**，浏览器决定每个元素的位置。
- 每个元素的实际尺寸、位置、层叠顺序（Z-index）等都会在这个阶段被计算出来。


### **5. 绘制（Painting）**

绘制阶段是浏览器根据布局信息，将所有元素的样式渲染到屏幕上的过程。这个阶段包括了：

- **绘制颜色**：背景色、文字颜色、边框、阴影等。
- **绘制文本**：文本内容和文本样式。
- **绘制图像**：比如 `img` 标签中的图片。
- **绘制边框和阴影**：这些都是样式的一部分。